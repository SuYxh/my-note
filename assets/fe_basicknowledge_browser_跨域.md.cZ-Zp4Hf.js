import{_ as s,c as i,o as a,V as l}from"./chunks/framework.hxTji2_l.js";const e="/my-note/assets/cors-process.EwQVB7Gm.png",u=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"fe/basicknowledge/browser/跨域.md","filePath":"fe/basicknowledge/browser/跨域.md","lastUpdated":1719478304000}'),n={name:"fe/basicknowledge/browser/跨域.md"},t=l('<div class="tip custom-block"><p class="custom-block-title">跨域的原因 —— 浏览器的同源策略</p><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy" target="_blank" rel="noreferrer">同源策略</a>是浏览器一个重要的安全策略，它用于限制一个 <code>origin</code> 的文档或者它加载的脚本如何能与另一个源的资源进行交互。它能帮助阻隔恶意文档，减少可能被攻击的媒介</p><p>同源的定义是两个 <code>URL</code> 的 <strong>协议</strong>、<strong>域名</strong>(子域名 + 主域名)、<strong>端口号</strong> 都相同，否则就会出现跨域</p></div><div class="tip custom-block"><p class="custom-block-title">同源策略的限制范围</p><ol><li>限制跨源网络访问: <code>AJAX</code> 请求不能发送</li><li>限制跨源脚本 <code>API</code> 访问: <code>DOM</code> 无法获得</li><li>限制跨源数据存储访问: <code>Cookie</code> <code>LocalStorage</code> 和 <code>IndexDB</code> 无法读取</li></ol><p>一般常说的跨域指网络跨域</p></div><h3 id="常用的跨域解决方案" tabindex="-1">常用的跨域解决方案 <a class="header-anchor" href="#常用的跨域解决方案" aria-label="Permalink to &quot;常用的跨域解决方案&quot;">​</a></h3><div class="tip custom-block"><p class="custom-block-title">常用的跨域解决方案</p><ol><li><strong>CORS</strong></li><li><strong>JSONP</strong></li><li>Nginx 反向代理</li><li>WebSocket</li><li>postMessage</li><li>document.domain</li></ol></div><h3 id="cors-跨源资源共享" tabindex="-1">CORS 跨源资源共享 <a class="header-anchor" href="#cors-跨源资源共享" aria-label="Permalink to &quot;CORS 跨源资源共享&quot;">​</a></h3><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS" target="_blank" rel="noreferrer">CORS (跨源资源共享)</a> 是 <a href="https://developer.mozilla.org/zh-CN/docs/Glossary/HTTP" target="_blank" rel="noreferrer">HTTP</a> 的一部分，它允许浏览器向跨源服务器发出 <code>XMLHttpRequest</code> 请求，从而解决了 <code>AJAX</code> 只能同源使用的限制。</p><blockquote><p><code>CORS</code> 需要浏览器和服务器同时支持，目前所有浏览器均已支持，只需服务器配置即可使用</p></blockquote><p>浏览器将 <code>CORS</code> 请求分成两类: <strong>简单请求</strong>和<strong>非简单请求</strong></p><h4 id="简单请求" tabindex="-1">简单请求 <a class="header-anchor" href="#简单请求" aria-label="Permalink to &quot;简单请求&quot;">​</a></h4><div class="tip custom-block"><p class="custom-block-title">简单请求必须同时满足以下条件</p><blockquote><p>日常开发只会关注前两点</p></blockquote><ul><li>请求方法是以下三种方法之一 <ul><li><code>HEAD</code></li><li><code>GET</code></li><li><code>POST</code></li></ul></li><li>只使用了如下的安全首部字段，不得人为设置其他首部字段 <ul><li><code>Accept</code></li><li><code>Accept-Language</code></li><li><code>Content-Language</code></li><li><code>Content-Type</code> 仅限以下三种 <ul><li><code>application/x-www-form-urlencoded</code></li><li><code>multipart/form-data</code></li><li><code>text/plain</code></li></ul></li></ul></li><li>请求中的任意 <code>XMLHttpRequestUpload</code> 对象均没有注册任何事件监听器(使用 <code>XMLHttpRequest.upload</code> 属性访问<code>XMLHttpRequestUpload</code> 对象)</li><li>请求中没有使用 <code>ReadableStream</code> 对象</li></ul></div><h5 id="简单请求基本流程" tabindex="-1">简单请求基本流程 <a class="header-anchor" href="#简单请求基本流程" aria-label="Permalink to &quot;简单请求基本流程&quot;">​</a></h5><ol><li>浏览器会直接发出 <code>CORS</code> 请求并在请求头信息之中增加一个 <code>Origin</code> 字段(用来说明本次请求来自哪个源(协议 + 域名 + 端口))</li><li>服务器判断 <code>Origin</code> 字段决定是否同意这次请求 <ol><li>通过请求会在响应头增加 <code>CORS</code> 相关的字段(以<code>Access-Control-</code>开头)</li><li>拒绝请求时不会增加 <code>CORS</code> 相关的字段，浏览器会抛出异常</li></ol></li></ol><div class="tip custom-block"><p class="custom-block-title">简单请求响应头中的 CORS 字段</p><ul><li><code>Access-Control-Allow-Origin</code>: 只能是 <code>*</code>(接受任意域名的请求)或者是请求时 <code>Origin</code> 字段的值</li><li><code>Access-Control-Allow-Credentials</code>(可选): 是一个布尔值,表示是否允许发送 <code>Cookie</code></li><li><code>Access-Control-Expose-Headers</code>(可选): <code>CORS</code> 请求时 <code>XMLHttpRequest</code> 对象的 <code>getResponseHeader()</code> 方法只能拿到 6 个基本字段：<code>Cache-Control、Content-Language、Content-Type、Expires、Last-Modified、Pragma</code>。如果想拿到其他字段就必须在 <code>Access-Control-Expose-Headers</code> 里面指定</li></ul></div><div class="tip custom-block"><p class="custom-block-title">CORS 中的 Cookie 设置</p><p><code>CORS</code> 请求默认不发送 <code>Cookie</code>，如果需要发送需要满足如下条件</p><ul><li>服务器必须设置 <code>Access-Control-Allow-Credentials: true</code></li><li><code>Access-Control-Allow-Origin</code> 字段不能为 <code>*</code></li><li><code>AJAX</code> 请求的配置项需设置 <code>withCredentials = true</code></li></ul></div><h4 id="非简单请求" tabindex="-1">非简单请求 <a class="header-anchor" href="#非简单请求" aria-label="Permalink to &quot;非简单请求&quot;">​</a></h4><p>非简单请求是那种对服务器有特殊要求的请求，如请求方法是 <code>PUT</code> 或 <code>DELETE</code>，或者 <code>Content-Type</code> 字段的类型是 <code>application/json</code>。<br> 非简单请求会在正式通信之前增加一次 <code>HTTP</code> 查询请求，称为<strong>预检请求</strong>，用于获取服务器是否允许该实际请求，同时避免跨域请求对服务器的用户数据产生预期之外的影响</p><div class="tip custom-block"><p class="custom-block-title">预检请求</p><p>预检请求用的请求方法是 <code>OPTIONS</code> 表示这个请求是用来询问的</p><ul><li>在预检请求请求头信息里会包含如下字段 <ul><li><code>Origin</code>: 表示本次请求来自哪个源</li><li><code>Access-Control-Request-Method</code>: 用于列出浏览器的 <code>CORS</code> 请求会用到哪些 <code>HTTP</code> 方法</li><li><code>Access-Control-Request-Headers</code>(可选): 指定浏览器 <code>CORS</code> 请求会额外发送的头信息字段</li></ul></li><li>服务器通过后会在预检请求响应头中设置如下字段 <ul><li><code>Access-Control-Allow-Origin</code></li><li><code>Access-Control-Allow-Credentials</code>(可选)</li><li><code>Access-Control-Allow-Methods</code>: 表示服务器支持的所有跨域请求的方法(为了避免多次预检请求)</li><li><code>Access-Control-Allow-Headers</code>: 表示服务器支持的所有头信息字段，不限于浏览器在预检中请求的字段</li><li><code>Access-Control-Max-Age</code>(可选): 用来指定本次预检请求的有效期单位为秒，在有效期内将不发出另一条预检请求</li></ul></li></ul></div><p>一旦服务器通过了预检请求，以后每次浏览器正常的 <code>CORS</code> 请求，就都跟简单请求一样会有一个 <code>Origin</code> 头信息字段。服务器的回应也都会有一个 <code>Access-Control-Allow-Origin</code> 头信息字段</p><details class="details custom-block"><summary>CORS 请求过程</summary><p><img src="'+e+`" alt="CORS 请求过程"></p></details><p><a href="http://www.ruanyifeng.com/blog/2016/04/cors.html" target="_blank" rel="noreferrer">参考资料 —— 跨域资源共享 CORS 详解</a></p><h3 id="jsonp" tabindex="-1">JSONP <a class="header-anchor" href="#jsonp" aria-label="Permalink to &quot;JSONP&quot;">​</a></h3><p><code>JSONP</code> 是利用 <code>&lt;script&gt;</code> 标签没有跨域限制的漏洞，当前源可以得到从其他来源动态产生的 <code>JSON</code> 数据</p><p><strong><code>JSONP</code> 请求过程流程</strong></p><ol><li>前端定义一个解析的回调函数</li><li>创建 <code>script</code> 标签，其 <code>src</code> 指向接口地址并拼接好参数和回调函数名</li><li>后端处理数据并将其拼接到前端传入的回调函数中(拼接好的数据必须是一个合法的 <code>JavaScript</code> 脚本 )</li><li>浏览器执行后端返回的 <code>JavaScript</code> 脚本代码(调用定义好的回调函数)并删除刚创建的 <code>script</code> 标签</li></ol><details class="details custom-block"><summary>JSONP 代码实现</summary><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> normalizeParams</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">params</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">params) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Object.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">keys</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(params)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> \`\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">key</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}=\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">params</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">[</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">key</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">]</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">join</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&amp;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> jsonp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">url</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">params</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">resolve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> callback</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> \`jsonp_\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Date</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">()</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    window[callback] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      resolve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      document.body.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">removeChild</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(scriptEle);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    params.cb </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> callback;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> scriptEle</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> document.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createElement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;script&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    scriptEle.src </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> \`\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">url</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">url</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">includes</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;?&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&amp;&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;?&quot;}\${</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">normalizeParams</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      params</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    )</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    document.body.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">appendChild</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(scriptEle);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">jsonp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;https://www.baidu.com/sugrec&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  prod: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;pc&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  wd: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;跨域&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">then</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">res</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(res);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div></details><div class="tip custom-block"><p class="custom-block-title">JSONP 跨域优缺点</p><ul><li>优点: 实现简单，兼容性好</li><li>缺点 <ul><li>只支持 <code>GET</code> 请求</li><li>容易遭受 <code>XSS</code> 攻击</li></ul></li></ul></div><p><a href="https://juejin.cn/post/6844904126246027278" target="_blank" rel="noreferrer">了解更多跨域解决方案请点击 —— 10 种跨域解决方案</a></p>`,27),p=[t];function h(k,o,r,c,d,E){return a(),i("div",null,p)}const y=s(n,[["render",h]]);export{u as __pageData,y as default};
